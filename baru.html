<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Input Kertas Kerja</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f7fafc }
.card { border-radius:12px }
.required::after { content:" *"; color:#dc3545 }
</style>
</head>
<body class="p-4">
<div class="container">
<div class="card shadow-sm">
<div class="card-body">

<h4 class="fw-bold mb-2">Form Input KERTAS KERJA</h4>
<p class="text-muted">Data & bukti dukung tersimpan otomatis</p>

<form id="kk-form" class="row g-3">

<!-- IDENTITAS -->
<div class="col-md-2">
  <label class="required">NO</label>
  <input name="NO" id="no" class="form-control" readonly>
</div>

<div class="col-md-4">
  <label class="required">SKPD</label>
  <select name="SKPD" id="skpd" class="form-control" required>
    <option value="">-- Pilih SKPD --</option>
  </select>
</div>

<div class="col-md-4">
  <label class="required">UNIT</label>
  <select name="UNIT" id="unit" class="form-control" required disabled>
    <option value="">-- Pilih Unit --</option>
  </select>
</div>

<!-- PROGRAM & KEGIATAN -->
<div class="col-md-6"><label class="required">PROGRAM</label><input name="PROGRAM" class="form-control" required></div>
<div class="col-md-6"><label class="required">KEGIATAN</label><input name="KEGIATAN" class="form-control" required></div>
<div class="col-md-6"><label class="required">SUB KEGIATAN</label><input name="SUB KEGIATAN" class="form-control" required></div>
<div class="col-md-6"><label class="required">JUMLAH TERMIN</label><input name="JUMLAH TERMIN" type="number" class="form-control" required></div>

<!-- DOKUMEN -->
<div class="col-md-6"><label class="required">NAMA PPK</label><input name="NAMA PPK" class="form-control" required></div>
<div class="col-md-6"><label class="required">NOMOR DOKUMEN</label><input name="NOMOR DOKUMEN" class="form-control" required></div>
<div class="col-md-6"><label class="required">TGL DOKUMEN</label><input name="TGL DOKUMEN" type="date" class="form-control" required></div>
<div class="col-md-6"><label class="required">NOMOR SP2D</label><input name="NOMOR SP2D" class="form-control" required></div>
<div class="col-md-6"><label class="required">TGL SP2D</label><input name="TGL SP2D" type="date" class="form-control" required></div>

<!-- PENYEDIA -->
<div class="col-md-6"><label class="required">PIHAK PENYEDIA</label><input name="PIHAK PENYEDIA" class="form-control" required></div>
<div class="col-md-6"><label class="required">KODE REKENING BELANJA</label><input name="KODE REKENING BELANJA" class="form-control" required></div>
<div class="col-md-6"><label class="required">NAMA REK BELANJA</label><input name="NAMA REK BELANJA" class="form-control" required></div>

<!-- BARANG -->
<div class="col-md-6"><label class="required">KODEFIKASI BARANG</label><input name="KODEFIKASI BARANG" class="form-control" required></div>
<div class="col-md-6"><label class="required">NAMA BARANG</label><input name="NAMA BARANG" class="form-control" required></div>
<div class="col-md-12"><label class="required">URAIAN BARANG</label><textarea name="URAIAN BARANG" class="form-control" required></textarea></div>
<div class="col-md-4"><label class="required">SATUAN</label><input name="SATUAN" class="form-control" required></div>
<div class="col-md-4"><label class="required">JUMLAH BARANG</label><input name="JUMLAH BARANG" type="number" class="form-control" required></div>
<div class="col-md-4"><label class="required">HARGA SATUAN</label><input name="HARGA SATUAN" type="number" class="form-control" required></div>
<div class="col-md-4"><label class="required">JUMLAH TOTAL</label><input name="JUMLAH TOTAL" id="total" class="form-control" readonly></div>

<!-- BAST -->
<div class="col-md-4"><label class="required">NO BAST</label><input name="NO BAST" class="form-control" required></div>
<div class="col-md-4"><label class="required">TGL BAST</label><input name="TGL BAST" type="date" class="form-control" required></div>
<div class="col-md-4"><label class="required">NO SPV</label><input name="NO SPV" class="form-control" required></div>
<div class="col-md-4"><label class="required">TGL SPV</label><input name="TGL SPV" type="date" class="form-control" required></div>

<!-- FILE -->
<div class="col-md-12"><label class="required">BUKTI DUKUNG (PDF max 5MB)</label><input type="file" id="bukti_file" accept="application/pdf" class="form-control" required></div>

<div class="col-12 d-flex gap-2">
  <button class="btn btn-primary" type="submit">üíæ Simpan</button>
  <button class="btn btn-secondary" type="reset">üîÑ Reset</button>
</div>
</form>

<div id="status" class="mt-3"></div>
</div>
</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzd_xuKlHPAXyIwbim3ubyrlPaYINf4FujyjRMfiOqUfdrbvnzxDQPhMsOQYASgOEs1-A/exec"; // Ganti dengan URL Web App yang dipublikasikan

// HITUNG TOTAL
const harga = document.querySelector('[name="HARGA SATUAN"]');
const jumlah = document.querySelector('[name="JUMLAH BARANG"]');
const total = document.getElementById("total");
function hitung() { total.value = (+harga.value||0)*(+jumlah.value||0); }
harga.oninput = hitung; jumlah.oninput = hitung;

// LOAD NO
fetch(SCRIPT_URL+"?action=getNextNo").then(r=>r.json()).then(j=>no.value=j.nextNo);

// LOAD SKPD
fetch(SCRIPT_URL+"?action=getSKPDUnit").then(r=>r.json()).then(j=>{
  skpd.innerHTML='<option value="">-- Pilih SKPD --</option>';
  j.skpdList.forEach(v=>skpd.innerHTML+=`<option value="${v}">${v}</option>`);
});

// LOAD UNIT OTOMATIS SESUAI SKPD
skpd.onchange = () => {
  unit.innerHTML = '<option value="">-- Pilih Unit --</option>';
  unit.disabled = true;
  if(!skpd.value) return;
  fetch(SCRIPT_URL+"?action=getUnitBySKPD&skpd="+encodeURIComponent(skpd.value))
    .then(r=>r.json()).then(j=>{
      const units = j.unitList||[];
      units.forEach(v=>unit.innerHTML+=`<option value="${v}">${v}</option>`);
      if(units.length===1) unit.value=units[0];
      unit.disabled=false;
    }).catch(err=>{ console.error(err); unit.disabled=false; });
};

// FILE TO BASE64
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=err=>reject(err);
    reader.readAsDataURL(file);
  });
}

// SUBMIT FORM AJAX
document.getElementById("kk-form").onsubmit=async function(e){
  e.preventDefault();
  const status = document.getElementById("status");
  status.innerHTML='<div class="alert alert-info">‚è≥ Menyimpan data...</div>';

  const formData=new FormData(this);
  const fileInput=document.getElementById("bukti_file");
  const file=fileInput.files[0];
  if(!file){ status.innerHTML='<div class="alert alert-danger">‚ùå File belum dipilih</div>'; return; }

  const base64 = await fileToBase64(file);
  const payload={};
  formData.forEach((v,k)=>payload[k]=v);
  payload.fileName=file.name;
  payload.fileBase64=base64.split(",")[1];

  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(payload),
    headers:{"Content-Type":"application/json"}
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.success){
      status.innerHTML='<div class="alert alert-success">‚úÖ Data dan file berhasil disimpan</div>';
      this.reset(); total.value="";
    } else {
      status.innerHTML='<div class="alert alert-danger">‚ùå Error: '+j.message+'</div>';
    }
  })
  .catch(err=>status.innerHTML='<div class="alert alert-danger">‚ùå Error: '+err.message+'</div>');
};
</script>
</body>
</html>
